import{_ as z,r as d,u as J,c as r,a as c,b as t,d as L,f as h,g as i,v as f,n as Q,t as b,h as V,i as X,F as S,e as w,w as G,o as m}from"./index-D2lfA9pA.js";import{u as H,a as K}from"./medications-CBhGBPKD.js";import{u as W}from"./orders-BpA5k6F3.js";const Y={class:"view order-creation-view"},Z={class:"order-meta"},ee=["title"],te={class:"wide"},ae={class:"rows"},oe=["onUpdate:modelValue"],ne=["value"],se=["onUpdate:modelValue","placeholder"],le={class:"spacer"},re={class:"quantity"},ie={class:"unit"},ue=["onUpdate:modelValue"],de=["onClick"],ce={key:0,class:"message"},me={__name:"OrderCreation",setup(ve){const l=d([{_uid:Date.now()+"-r0",medicationId:"",quantity:1,notes:""}]),u=d(""),x=H();K();const T=W(),v=J(),O=r(()=>v.currentUser&&v.currentUser.name?v.currentUser.name:""),C=r(()=>_.value&&_.value.trim()||O.value||""),p=d("auto"),N=r(()=>v.mockUsers&&v.mockUsers.some(o=>o.name===C.value)),I=r(()=>p.value==="auto"?N.value:p.value==="internal"),R=r(()=>I.value?"INT":"EXT"),B=r(()=>I.value?"Internal":"External"),D=r(()=>I.value?"internal":"external"),M=r(()=>x.options);function g(o){return o?x.byId(o):null}function P(o){const e=g(o.medicationId);return e&&e.quantity?`Amount (e.g. ${e.quantity})`:e&&e.dosage?`Amount (dosage ${e.dosage})`:"Amount"}function $(){l.value.push({_uid:Date.now()+"-"+Math.random().toString(36).slice(2,7),medicationId:"",quantity:1,notes:""})}const y=d(""),_=d(O.value||""),k=d(!1),q=d("");function A(o){l.value.length===1?l.value[0]={_uid:Date.now()+"-r0",medicationId:"",quantity:1,notes:""}:l.value.splice(o,1)}function E(){for(const o of l.value){if(!o.medicationId)return{ok:!1,reason:"Please select a medication for each row."};if(o.quantity==null||isNaN(o.quantity)||o.quantity<=0)return{ok:!1,reason:"Quantity must be greater than 0."}}return{ok:!0}}async function F(){u.value="";const o=E();if(!o.ok){u.value=o.reason;return}if(!y.value){u.value="Please provide a needed-by date.";return}const e=l.value.map(s=>({medicationId:s.medicationId,amount:s.quantity})),a={name:C.value||"Order",date:y.value,medications:e,isInternal:I.value,isRush:!!k.value};try{const s=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){const j=(await s.json().catch(()=>({}))).detail||`Failed to place order (${s.status})`;throw new Error(j)}const n=await s.json();T.addOrder({neededBy:a.date,orderedBy:a.name,isRush:a.isRush,comment:q.value||"",items:l.value.map(U=>({medicationId:U.medicationId,quantity:U.quantity,notes:U.notes||""})),orderType:a.isInternal?"internal":"external",backendId:n.id}),u.value=`Order placed â€” id ${n.id}`,l.value=[{_uid:Date.now()+"-r0",medicationId:"",quantity:1,notes:""}],y.value="",k.value=!1,q.value="",p.value="auto"}catch(s){console.error(s),u.value=`Failed to place order: ${s.message}`}}return(o,e)=>(m(),c("div",Y,[e[12]||(e[12]=t("h1",null,"Create Order",-1)),t("form",{onSubmit:G(F,["prevent"]),class:"order-form"},[t("fieldset",Z,[t("label",null,[e[5]||(e[5]=h("Needed by: ",-1)),i(t("input",{type:"date","onUpdate:modelValue":e[0]||(e[0]=a=>y.value=a)},null,512),[[f,y.value]])]),t("label",null,[e[7]||(e[7]=h("Ordered by: ",-1)),i(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=a=>_.value=a)},null,512),[[f,_.value]]),t("span",{class:Q(["order-type-badge",D.value]),title:B.value},b(R.value),11,ee),i(t("select",{class:"order-type-select","onUpdate:modelValue":e[2]||(e[2]=a=>p.value=a),title:"Order type override"},[...e[6]||(e[6]=[t("option",{value:"auto"},"Auto",-1),t("option",{value:"internal"},"Internal",-1),t("option",{value:"external"},"External",-1)])],512),[[V,p.value]])]),t("label",null,[i(t("input",{type:"checkbox","onUpdate:modelValue":e[3]||(e[3]=a=>k.value=a)},null,512),[[X,k.value]]),e[8]||(e[8]=h(" Rush order",-1))]),t("label",te,[e[9]||(e[9]=h("Comment: ",-1)),i(t("input",{type:"text","onUpdate:modelValue":e[4]||(e[4]=a=>q.value=a),placeholder:"Optional comment"},null,512),[[f,q.value]])])]),t("div",ae,[(m(!0),c(S,null,w(l.value,(a,s)=>(m(),c("div",{key:a._uid,class:"order-row"},[i(t("select",{"onUpdate:modelValue":n=>a.medicationId=n,class:"med-select"},[e[10]||(e[10]=t("option",{value:"",disabled:""},"Select medication",-1)),(m(!0),c(S,null,w(M.value,n=>(m(),c("option",{key:n.value,value:n.value},b(n.label),9,ne))),128))],8,oe),[[V,a.medicationId]]),i(t("input",{type:"number","onUpdate:modelValue":n=>a.quantity=n,min:"0",step:"1",class:"qty",placeholder:P(a)},null,8,se),[[f,a.quantity,void 0,{number:!0}]]),t("div",le,[t("span",re,b(g(a.medicationId)?.quantity*a.quantity||""),1),t("span",ie,b(g(a.medicationId)?.unit||""),1)]),i(t("input",{type:"text","onUpdate:modelValue":n=>a.notes=n,placeholder:"Notes (optional)",class:"notes"},null,8,ue),[[f,a.notes]]),t("button",{type:"button",class:"remove",onClick:n=>A(s)},"Remove",8,de)]))),128))]),t("div",{class:"controls"},[t("button",{type:"button",onClick:$},"Add medicine"),e[11]||(e[11]=t("button",{type:"submit",class:"submit"},"Place order",-1))])],32),u.value?(m(),c("div",ce,b(u.value),1)):L("",!0)]))}},be=z(me,[["__scopeId","data-v-202229bb"]]);export{be as default};
